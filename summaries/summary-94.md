# ECMAScript仕様輪読会 第94回

## 1. 前回のあらすじ・振り返り

前回の内容について、以下の点の振り返りが行われました。

*   **UTC(t) と Local Time の変換**
    *   時間の重複（夏時間の終了時など）や欠落（夏時間の開始時など）が発生する可能性がある。
    *   壁時計時間（Wall Clock Time）の精度が変わるタイミングについての事例。
*   **日本標準時（JST）の歴史的経緯**
    *   1888年1月1日に標準時が施行された際、それまでのオフセット `+09:18:59` から `+09:00:00` へ変更された。
    *   これにより、約18分間の「巻き戻し（重複）」が発生したことになり、`Date` オブジェクトの挙動などで興味深いエッジケースとなる。
*   **日付時刻の構成要素**
    *   `Time`, `Day`, `Date` などに加え、`FullYear` の仕様について。
    *   `Date` コンストラクタの第一引数に `0` ～ `99` を渡すと、1900年代（1900～1999）として扱われる仕様の再確認。
*   **TimeClip**
    *   ECMAScriptで表現可能な `Time Value` の範囲（約±27万年）に収める処理。

---

## 2. Date Time String Format (20.4.1.15)

ECMAScriptにおける日付時刻の文字列表現についての定義が読み進められました。

### 基本仕様
*   ISO 8601の「カレンダー日付拡張フォーマット」を単純化したものに基づいている。
*   **フォーマット:** `YYYY-MM-DDTHH:mm:ss.sssZ`
*   **各要素の定義:**
    *   `YYYY`: 先発グレゴリオ暦（proleptic Gregorian calendar）における年。
        *   `0000` ～ `9999` の4桁。
        *   または、拡張年表現（Expanded Years）として `+` か `-` に続く6桁の数字。
    *   `-`: ハイフン（文字通り2回出現）。
    *   `MM`: 月（01～12）。
    *   `DD`: 日（01～31）。
    *   `T`: 時間要素の始まりを示す区切り文字（文字通り出現）。
    *   `HH`: 時（00～24）。
    *   `:`: コロン（文字通り2回出現）。
    *   `mm`: 分（00～59）。
    *   `ss`: 秒（00～59）。
    *   `.`: ドット（文字通り出現）。
    *   `sss`: ミリ秒（000～999、3桁である必要がある）。
    *   `Z`: UTCオフセット表現。
        *   UTCそのものの場合は `Z`。
        *   それ以外は `+` または `-` に続く `HH:mm` 形式（Time Zone Offset String Formatのサブセット）。

### 日付のみの形式
*   `YYYY-MM-DD` のような日付のみの形式も含まれる。
*   これに時刻フォーマットが続く場合も、オプションでUTCオフセットが付与される。

### 「24:00」と「00:00」の区別
*   一日の始まりと終わりは共に深夜（midnight）であるため、一つの日付に関連付けられる2つの深夜を区別するために `00:00` と `24:00` という表記が利用可能。
*   **仕様上の定義:** 以下の2つの表記は**全く同じ時点**を指す。
    *   `1995-02-04T24:00`
    *   `1995-02-05T00:00`
*   **ISO 8601との整合性:**
    *   ISO 8601では「時間間隔（Time Interval）」を記述するためにこの記法（24:00）を予約しており、単一の時点を表すためには許可していない場合があるが、ECMAScriptではこの解釈を一貫させている。
    *   *補足議論:* ISO 8601も2022年の改定（Amendment）で `24:00` の使用が再導入されたとの情報あり（以前は削除されていた時期があった）。

### タイムゾーンの略称について
*   `EST`（Eastern Standard Time）や `CET`（Central European Time）のような市民用タイムゾーン（Civil Time Zones）の略称に関する国際標準は存在しない。
*   同じ略称が全く異なるタイムゾーンで使われることもある（例: EST）。
*   そのため、ISO 8601および本フォーマットでは、**数値によるオフセット表記**を指定している。

---

## 3. Expanded Years (拡張年表現)

1970年1月1日を基準とした約±273,790年の範囲（Time Valueの範囲）をカバーするための仕様です。

*   **フォーマット:**
    *   6桁の数字と、必ずプレフィックスとして `+` または `-` を付ける必要がある（例: `+002026`）。
    *   双方の合意（mutual agreement）が必要なISO 8601の拡張とは異なり、ECMAScriptではこの形式を定めている。
*   **0年の扱い:**
    *   0年は正の数として扱われ、`+000000` と表記されなければならない。
    *   `-000000` は無効（Invalid）。
*   **範囲外の扱い:**
    *   Time Valueの範囲外の時点を表す文字列は、`Date.parse` において「認識不能（unrecognizable）」として扱われ、`NaN` を返す。
*   **具体例:**
    *   紀元前1年は `0` 年（`+000000`）となる（天文学的記法と同様）。紀元前ではなく西暦0年という概念。
    *   `0001 BC` = `0` (year)
    *   `-271821-04-20...` （紀元前約27万年）
    *   `+275760-09-13...` （西暦約27万年）

---

## 4. Time Zone Offset String Format と文法定義

タイムゾーンオフセットの文字列形式（UTCから派生）についての定義です。ここで文法記法（Grammar Notation）に関する深い議論が行われました。

### `:::` (3つのコロン) の意味
仕様書に出てくる `NumericStringGrammar` の定義において、`:::` という記法が使われている点についての解説がありました。

*   **`:` (1つ):** Syntactic Grammar（構文的文法）。
*   **`::` (2つ):** Lexical & RegExp Grammar（字句および正規表現文法）。
*   **`:::` (3つ):** **Numeric String Grammar**。
    *   これはソースコード（Source Text）をパースするためのものではなく、ランタイム（実行時）において、文字列を数値や特定の形式として解釈するために使われる。
    *   例: `StringToNumber` の変換や、今回の `Date.parse` 等で文字列を解釈する際など。

### Numeric String Grammar の詳細と混乱
議論の中で、参照していた箇所が `Time Zone Offset String Format` の文法そのものではなく、汎用的な `String to Number`（7.1.4.1）の文法定義（`StringNumericLiteral`）を読んでいたことが判明しましたが、`:::` の概念理解には役立ちました。

*   **StringNumericLiteral:**
    *   空白（`StrWhiteSpace`）が許容される。
    *   10進数（Decimal）だけでなく、非10進数（NonDecimal、2進/8進/16進など）も定義に含まれる。
    *   数値のセパレーター（`_`）は、ソースコード上では許容されるが、文字列からの変換（`Number("1_000")`など）では許容されない（セパレーター無しの定義が参照されているため）。

### タイムゾーンオフセットの文法構造
改めてタイムゾーン周りの文法を確認した際の疑問点：
*   **TemporalDecimalFraction:** 文法上、タイムゾーンの定義の中に「秒」や「小数点以下の秒（ミリ秒など）」まで書けそうな定義（`MinuteSecond` の後に小数点が続くなど）が見受けられた。
*   **実験:** 実際にブラウザのコンソールで `Date.parse` や `new Date()` に、タイムゾーンオフセット部分に細かい数値（例: `+09:00:00.000` など）を入れて試行。
    *   多くの入力は通るが、オフセットとして正しく解釈されているか、単に無視されているか、あるいは `Invalid Date` になるか挙動が複雑。
    *   `+09:18:59` のような秒単位のオフセットは、1888年のJSTのような歴史的な時刻を表現する際には必要になる可能性がある。
    *   しかし、オフセット部分に「ミリ秒」まで指定する実用的な意味は不明（仕様の意図が読み取れない部分として残された）。

## 次回の予定
*   今回の続きである「Time Zone Offset String Format」の詳細な読み解きから再開予定。
*   特に文法定義の `TemporalDecimalFraction` 等が具体的にどう効いてくるのかを確認する。
